<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Churrasco do Chefe ‚Äî Atendimento</title>
<meta name="theme-color" content="#ff6a00">

<!-- ====== STYLES (tudo integrado) ====== -->
<style>
  :root{
    --bg:#0f0f10; --panel:#151516; --accent:#ff6a00; --accent-2:#ff8a2b; --muted:#bfbfbf;
    --glass: rgba(255,255,255,0.03); --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Arial,Helvetica,sans-serif; background:var(--bg); color:#fff;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  /* header */
  header{
    background: linear-gradient(90deg,var(--accent), var(--accent-2));
    display:flex; align-items:center; gap:12px; padding:12px 16px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.3); position:sticky; top:0; z-index:50;
  }
  .logo { width:56px; height:56px; border-radius:10px; background:#fff; overflow:hidden; display:flex; align-items:center; justify-content:center; }
  .logo img{width:100%; height:100%; object-fit:cover}
  .title { font-weight:800; font-size:18px; line-height:1 }
  .subtitle { font-size:12px; opacity:0.95; margin-top:2px }

  .top-controls{margin-left:auto; display:flex; gap:8px; align-items:center}
  .icon-btn{background:transparent; border:1px solid rgba(255,255,255,0.06); padding:8px; border-radius:8px; cursor:pointer; color:var(--muted); font-size:16px}

  /* layout */
  .container{ display:grid; grid-template-columns: 1fr 380px; gap:16px; padding:16px; max-width:1200px; margin:18px auto; }
  @media (max-width:980px){ .container{ grid-template-columns: 1fr; padding:12px } }

  /* panel chat */
  .panel{ background:var(--panel); border-radius:var(--radius); padding:14px; min-height:60vh; box-shadow: 0 8px 30px rgba(0,0,0,0.45); display:flex; flex-direction:column; gap:12px; }
  #chat{ height:48vh; overflow:auto; padding:12px; border-radius:8px; background: linear-gradient(180deg,var(--glass),transparent); }

  /* bot avatar + messages */
  .bot-line{ display:flex; align-items:flex-start; gap:8px; margin:10px 0; }
  .bot-avatar{ width:36px; height:36px; border-radius:50%; background:var(--accent); color:#111; font-weight:900; display:flex; align-items:center; justify-content:center; }
  .msg-bot{ display:inline-block; background:rgba(255,255,255,0.03); padding:10px 12px; border-radius:10px; border-left:4px solid var(--accent); max-width:85%; box-shadow:0 6px 18px rgba(0,0,0,0.25); }
  .msg-user{ display:block; width:max-content; background:var(--accent); color:#111; padding:10px 12px; border-radius:10px; margin:8px 0 8px auto; max-width:85%; box-shadow:0 6px 18px rgba(0,0,0,0.15); }

  /* typing */
  #typing{ min-height:24px; }
  .typing{ display:flex; gap:6px; margin:10px 0; align-items:center; }
  .dot{ width:8px; height:8px; border-radius:50%; background:var(--accent); animation:blink 1.4s infinite; opacity:.3; }
  .dot:nth-child(2){ animation-delay:.15s } .dot:nth-child(3){ animation-delay:.3s }
  @keyframes blink{ 0%{ opacity:.2 } 50%{ opacity:1 } 100%{ opacity:.2 } }

  /* fade */
  .fade-msg{ animation: fadeIn .32s ease }
  @keyframes fadeIn { from{ opacity:0; transform:translateY(6px) } to{ opacity:1; transform:none } }

  /* categories and items */
  #categoria{ display:flex; gap:8px; flex-wrap:wrap; padding:8px 0; }
  .cat-btn{ background:transparent; border:1px solid rgba(255,255,255,0.06); padding:10px 12px; border-radius:10px; cursor:pointer; transition:transform .12s; font-weight:700; color:var(--muted) }
  .cat-btn:hover{ transform:translateY(-4px); box-shadow:0 6px 18px rgba(0,0,0,0.35) }
  .item-btn{ display:block; margin:8px 0; padding:10px; border-radius:10px; border:none; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#111; font-weight:800; cursor:pointer; width:100%; text-align:left }

  /* chat input */
  .chat-input{ display:flex; gap:8px; margin-top:6px }
  .chat-input input{ flex:1; padding:12px; border-radius:10px; border:none; outline:none; background:rgba(255,255,255,0.04); color:inherit }
  .chat-input button{ padding:12px 16px; border:none; border-radius:10px; background:var(--accent); color:#111; font-weight:900; cursor:pointer }

  /* cart sidebar */
  .cart{ background:var(--panel); border-radius:var(--radius); padding:12px; height:calc(60vh + 8px); display:flex; flex-direction:column; gap:10px; box-shadow: 0 8px 30px rgba(0,0,0,0.35) }
  .cart h3{ margin:0 0 8px 0 }
  .cart-list{ flex:1; overflow:auto; padding-right:6px; display:flex; flex-direction:column; gap:8px }
  .cart-item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px; border-radius:8px; background:rgba(255,255,255,0.02) }
  .qty{ display:flex; gap:6px; align-items:center }
  .small-btn{ background:transparent; border:1px solid rgba(255,255,255,0.06); padding:6px 8px; border-radius:8px; cursor:pointer; color:var(--muted) }
  .meta{ font-size:13px; color:var(--muted) }

  .extras{ display:flex; gap:8px; flex-direction:column }
  .input, textarea, select{ width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; font-size:14px }

  .total-row{ display:flex; justify-content:space-between; align-items:center; font-weight:800; font-size:18px; padding-top:6px }
  .final-btn{ width:100%; padding:12px; border:none; border-radius:10px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); font-weight:900; font-size:16px; cursor:pointer; color:#111; display:none }

  /* print preview modal */
  .preview-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; padding:20px; z-index:60 }
  .preview-box{ background:#fff; color:#111; max-width:700px; width:100%; border-radius:10px; padding:16px }

  @media (max-width:980px){
    .cart{ height:auto }
    .panel{ padding-bottom:12px }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <img src="logo.png" id="logoImg" alt="logo"
      onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2256%22 height=%2256%22><rect width=%2256%22 height=%2256%22 fill=%22%23ffffff%22/><text x=%2228%22 y=%2232%22 font-size=%2216%22 text-anchor=%22middle%22 fill=%22%23ff6a00%22 font-family=%22Arial%22>LOGO</text></svg>'">
  </div>

  <div>
    <div class="title">Churrasco do Chefe</div>
    <div class="subtitle meta">Atendimento autom√°tico ‚Äî toque pra pedir</div>
  </div>

  <div class="top-controls" role="toolbar" aria-label="Controles">
    <button class="icon-btn" id="themeToggle" title="Alternar tema">üåó</button>
    <button class="icon-btn" id="printBtn" title="Visualizar/Imprimir pedido">üñ®Ô∏è</button>
  </div>
</header>

<main class="container" role="main">
  <!-- painel principal / bot -->
  <section class="panel" aria-label="Atendimento">
    <div id="chat" class="fade-msg" aria-live="polite">
      <!-- mensagens iniciais geradas por JS -->
    </div>

    <div id="categoria" aria-label="Categorias"></div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
      <input id="logoInput" type="file" accept="image/*" style="display:none" />
      <button class="cat-btn" onclick="document.getElementById('logoInput').click()">üìÅ Subir Logo</button>
      <button class="cat-btn" onclick="clearCart()">‚ôªÔ∏è Limpar carrinho</button>
      <button class="cat-btn" onclick="showPreview()">üëÄ Visualizar Pedido</button>
    </div>

    <div id="typing" aria-hidden="true"></div>

    <div class="chat-input" role="form" aria-label="Enviar mensagem">
      <input id="msgBox" placeholder="Escreva: 'contra fil√©' ou 'menu'..." autocomplete="off" aria-label="Mensagem" />
      <button id="sendBtn" onclick="enviarMsg()">Enviar</button>
    </div>
  </section>

  <!-- sidebar carrinho -->
  <aside class="cart" aria-label="Carrinho">
    <h3>Seu Pedido</h3>

    <div class="cart-list" id="cartList" aria-live="polite"></div>

    <div class="extras">
      <label class="meta">Op√ß√£o de entrega</label>
      <select id="bairroSelect" class="input">
        <option value="Parque Paranhos|0">Parque Paranhos (Mag√©) ‚Äî R$0</option>
        <option value="Centro Mag√©|8">Centro Mag√© ‚Äî R$8</option>
        <option value="Ponta Negra|12">Ponta Negra ‚Äî R$12</option>
        <option value="Outros|20">Outros ‚Äî R$20</option>
      </select>

      <label class="meta">Observa√ß√µes</label>
      <textarea id="obs" rows="2" placeholder="Ex: sem pimenta, corte fino..." class="input"></textarea>

      <div style="display:flex; gap:8px; align-items:center">
        
      </div>
    </div>

    <div class="total-row">
      <div class="meta">Total (itens)</div>
      <div id="subtotalText">R$ 0.00</div>
    </div>

    <div class="total-row">
      <div class="meta">Entrega</div>
      <div id="freteText">R$ 0.00</div>
    </div>

    <div class="total-row" style="font-size:20px; padding-top:6px">
      <div>Total</div>
      <div id="grandTotal" style="color:var(--accent)">R$ 0.00</div>
    </div>

    <div style="display:flex; gap:8px; margin-top:6px">
      <button id="finalizarBtn" class="final-btn" aria-label="Finalizar pedido e enviar por WhatsApp">Finalizar (WhatsApp)</button>
    </div>

    <div style="margin-top:8px; font-size:12px; color:var(--muted)">
      WhatsApp: <b>+55 21 98700-1907</b>
    </div>
  </aside>
</main>

<!-- Preview modal -->
<div id="previewModal" class="preview-modal" role="dialog" aria-hidden="true">
  <div class="preview-box">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <h3>Visualizar pedido</h3>
      <div>
        <button class="small-btn" onclick="closePreview()">Fechar</button>
      </div>
    </div>
    <div id="previewContent" style="margin-top:12px; max-height:60vh; overflow:auto"></div>
    <div style="display:flex; gap:8px; margin-top:12px">
      <button class="small-btn" onclick="printOrder()" style="background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#111; border:none">Imprimir</button>
      <button class="small-btn" onclick="copyOrder()">Copiar texto</button>
    </div>
  </div>
</div>

<!-- ====== SCRIPTS (tudo integrado) ====== -->
<script>
/* ================= CONFIGURA√á√ÉO E DADOS ================= */
const WA_NUMBER = "5521987001907"; // n√∫mero do estabelecimento (padr√£o)
const PRODUCTS = {
  "Espetos": {
    "Contra fil√©": 12,
    "Carne com bacon": 10,
    "Medalh√£o de carne": 12,
    "Lingui√ßa Toscana": 8,
    "Lingui√ßa de frango": 8,
    "Lingui√ßa mineira": 8,
    "Tulipa": 10,
    "Drumet": 10,
    "Cora√ß√£o": 12,
    "Medalh√£o de frango": 12,
    "Queijo coalho": 12,
    "P√£o de alho": 8
  },
  "Frangos": {
    "Frango assado na brasa + molho + farofa": 25,
    "Frango na brasa + arroz + farofa + vinagrete + feij√£o tropeiro": 40,
    "Frango assado + lingui√ßa Toscana + arroz + farofa + molho + feij√£o tropeiro + salpic√£o": 60
  },
  "Churrascos mistos": {
    "Churrasco misto": 50,
    "Churrasco misto + arroz + farofa + molho": 70,
    "Churrasco misto + arroz + feij√£o tropeiro + molho": 80
  },
  "Guarni√ß√µes": {
    "Arroz":15,
    "Feij√£o tropeiro":25,
    "Salpic√£o":25,
    "Farofa":10,
    "Vinagrete":7
  }
};

/* ================= ESTADO ================= */
let cart = {}; // chave: nome -> {name, price, qty}
let enderecoLocal = "";
let enderecoNumero = "";
let clienteNome = "";
let clienteTelefone = "";
let prontoParaFinalizar = false;
let geo = null; // {lat, lng, label}

/* ================= ELEMENTOS ================= */
const chatEl = document.getElementById('chat');
const typingEl = document.getElementById('typing');
const msgBox = document.getElementById('msgBox');
const categoriaEl = document.getElementById('categoria');
const cartListEl = document.getElementById('cartList');
const subtotalText = document.getElementById('subtotalText');
const freteText = document.getElementById('freteText');
const grandTotalEl = document.getElementById('grandTotal');
const bairroSelect = document.getElementById('bairroSelect');
const obsInput = document.getElementById('obs');
const geoBtn = document.getElementById('geoBtn');
const geoStatus = document.getElementById('geoStatus');
const finalizarBtn = document.getElementById('finalizarBtn');
const previewModal = document.getElementById('previewModal');
const previewContent = document.getElementById('previewContent');
const previewClose = document.getElementById('previewModal');

/* ================= SONS ================= */
const clickSound = new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_6bb8897e98.mp3?filename=click-124467.mp3");
clickSound.volume = 0.18;
function playClick(){ clickSound.currentTime = 0; clickSound.play().catch(()=>{}); }

/* ================= UTIL ================= */
function formatBR(v){ return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function saveCart(){ try{ localStorage.setItem('churrasco_cart', JSON.stringify(cart)); }catch(e){} }
function loadCart(){ try{ const s = localStorage.getItem('churrasco_cart'); if(s) cart = JSON.parse(s); }catch(e){} }

/* ================= CHAT UI (bot + typing) ================= */
function botDigitando(){ typingEl.innerHTML = `<div class="typing fade-msg"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`; }
function botParar(){ typingEl.innerHTML = ''; }

function addMsgBot(text, delay=700){
  botDigitando();
  setTimeout(()=> {
    botParar();
    const line = document.createElement('div');
    line.className = 'bot-line fade-msg';
    line.innerHTML = `<div class="bot-avatar">C</div><div class="msg-bot">${escapeHtml(text).replace(/\n/g,'<br>')}</div>`;
    chatEl.appendChild(line);
    chatEl.scrollTop = chatEl.scrollHeight;
    playClick();
  }, delay);
}

function addMsgUser(text){
  const div = document.createElement('div');
  div.className = 'msg-user fade-msg';
  div.innerText = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
  playClick();
}

/* ================= CATEGORIAS E ITENS ================= */
function renderCategories(){
  categoriaEl.innerHTML = '';
  Object.keys(PRODUCTS).forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'cat-btn';
    btn.innerText = cat;
    btn.onclick = ()=> renderItems(cat);
    categoriaEl.appendChild(btn);
  });
}
function renderItems(cat){
  const box = document.createElement('div');
  box.className = 'msg-bot fade-msg';
  let html = `<b>${cat}</b><div style="margin-top:8px">`;
  Object.entries(PRODUCTS[cat]).forEach(([name,price])=>{
    const safe = name.replace(/'/g,"\\'").replace(/"/g,'\\"');
    html += `<button class="item-btn" onclick="addToCart('${safe}',${price})">${name} ‚Äî ${formatBR(price)}</button>`;
  });
  html += `</div>`;
  box.innerHTML = html;
  chatEl.appendChild(box);
  chatEl.scrollTop = chatEl.scrollHeight;
}

/* ================= CARRINHO ================= */
function addToCart(name, price){
  if(cart[name]) cart[name].qty++;
  else cart[name] = { name, price, qty: 1 };
  renderCart();
  addMsgBot(`Adicionado: ${name} ‚Äî ${formatBR(price)}`, 350);
}
function changeQty(name, delta){
  if(!cart[name]) return;
  cart[name].qty += delta;
  if(cart[name].qty <= 0) delete cart[name];
  renderCart();
}
function removeItem(name){
  delete cart[name];
  renderCart();
}
function clearCart(){
  if(confirm('Deseja realmente limpar o carrinho?')){ cart = {}; renderCart(); }
}
function renderCart(){
  cartListEl.innerHTML = '';
  let subtotal = 0;
  const keys = Object.keys(cart);
  if(keys.length === 0){
    cartListEl.innerHTML = `<div style="color:var(--muted); font-size:13px">Carrinho vazio ‚Äî adicione itens pelo chat ou clicando no card√°pio.</div>`;
  } else {
    keys.forEach(k=>{
      const it = cart[k];
      subtotal += it.price * it.qty;
      const row = document.createElement('div');
      row.className = 'cart-item';
      const safe = it.name.replace(/'/g,"\\'").replace(/"/g,'\\"');
      row.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(it.name)}</div>
          <div class="meta">${formatBR(it.price)} x ${it.qty} = ${formatBR(it.price*it.qty)}</div>
        </div>
        <div style="display:flex;flex-direction:column; gap:6px; align-items:flex-end">
          <div class="qty" role="group" aria-label="Quantidade">
            <button class="small-btn" aria-label="Diminuir" onclick="changeQty('${safe}', -1)">-</button>
            <div style="min-width:28px; text-align:center">${it.qty}</div>
            <button class="small-btn" aria-label="Aumentar" onclick="changeQty('${safe}', 1)">+</button>
          </div>
          <div><button class="small-btn" aria-label="Remover" onclick="removeItem('${safe}')">Remover</button></div>
        </div>
      `;
      cartListEl.appendChild(row);
    });
  }

  // frete do select
  const selected = (bairroSelect.value || '').split('|');
  const frete = parseFloat(selected[1]||0) || 0;
  subtotalText.innerText = `R$ ${subtotal.toFixed(2)}`;
  freteText.innerText = `R$ ${frete.toFixed(2)}`;
  grandTotalEl.innerText = `R$ ${(subtotal+frete).toFixed(2)}`;

  // persist
  saveCart();
}

/* ================= FLUXO AUTOM√ÅTICO (ENDERE√áO / NOME / TELEFONE) ================= */
let aguardandoLocal = false;
let aguardandoNumero = false;
let aguardandoNome = false;
let aguardandoTelefone = false;

function perguntarLocal(){
  aguardandoLocal = true;
  addMsgBot("üìç Onde ser√° a entrega? Informe rua, bairro ou ponto de refer√™ncia.");
}
function perguntarNumero(){
  aguardandoNumero = true;
  addMsgBot("üè† Agora digite o n√∫mero e complemento (ex: 123, Apto 101).");
}
function perguntarNome(){
  aguardandoNome = true;
  addMsgBot("üë§ Qual o seu nome?");
}
function perguntarTelefone(){
  aguardandoTelefone = true;
  addMsgBot("üì± Qual o seu telefone (ex: 21 9xxxx-xxxx)?");
}

/* processa respostas livres do usu√°rio no chat */
function processarRespostaFluxo(text){
  const t = text.trim();
  if(aguardandoLocal){
    enderecoLocal = t;
    aguardandoLocal = false;
    perguntarNumero();
    return true;
  }
  if(aguardandoNumero){
    enderecoNumero = t;
    aguardandoNumero = false;
    perguntarNome();
    return true;
  }
  if(aguardandoNome){
    clienteNome = t;
    aguardandoNome = false;
    perguntarTelefone();
    return true;
  }
  if(aguardandoTelefone){
    clienteTelefone = t;
    aguardandoTelefone = false;
    prontoParaFinalizar = true;
    addMsgBot("‚úî Pronto! Endere√ßo e contato registrados ‚Äî agora voc√™ pode finalizar o pedido.", 400);
    finalizarBtn.style.display = 'block';
    return true;
  }
  return false;
}

/* ================= LOCALIZA√á√ÉO GPS ================= */
geoBtn.addEventListener('click', ()=> {
  if(!navigator.geolocation){ alert('Geolocaliza√ß√£o n√£o dispon√≠vel neste navegador.'); return; }
  geoStatus.innerText = 'Solicitando...';
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    geo = { lat, lng, label: `https://www.google.com/maps/search/?api=1&query=${lat},${lng}` };
    geoStatus.innerHTML = 'Local enviado ‚úîÔ∏è';
    playClick();
  }, err => {
    geoStatus.innerText = 'Falha ao obter localiza√ß√£o';
    console.warn(err);
  }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
});

/* ================= MENSAGEM PARA WHATSAPP ================= */
function montarTextoWhatsApp(){
  let lines = [];
  lines.push("üçñ *Novo Pedido - Churrasco do Chefe* üçñ");
  lines.push("");
  let subtotal = 0;
  Object.values(cart).forEach(it => {
    lines.push(`‚Ä¢ ${it.name} ‚Äî ${formatBR(it.price)} x ${it.qty} = ${formatBR(it.price*it.qty)}`);
    subtotal += it.price * it.qty;
  });
  lines.push("");
  const selected = (bairroSelect.value || '').split('|');
  const bairro = selected[0] || '';
  const frete = parseFloat(selected[1]||0) || 0;
  lines.push(`Subtotal: ${formatBR(subtotal)}`);
  lines.push(`Entrega (${bairro}): ${formatBR(frete)}`);
  lines.push(`*Total: ${formatBR(subtotal+frete)}*`);
  lines.push("");
  if(enderecoLocal) lines.push(`üìç Local da entrega: ${enderecoLocal}`);
  if(enderecoNumero) lines.push(`üè† N√∫mero / Complemento: ${enderecoNumero}`);
  if(geo && geo.label) lines.push(`üìç Link de localiza√ß√£o: ${geo.label}`);
  lines.push("");
  if(clienteNome) lines.push(`üë§ Nome: ${clienteNome}`);
  if(clienteTelefone) lines.push(`üì± Telefone: ${clienteTelefone}`);
  if(obsInput.value.trim()) lines.push(`üìù Observa√ß√µes: ${obsInput.value.trim()}`);
  lines.push("");
  lines.push("‚Äî Obrigado! Aguardo confirma√ß√£o.");
  return lines.join("\n");
}

/* ================= FINALIZAR (integra WhatsApp) ================= */
finalizarBtn.addEventListener('click', finalizeFlow);

function finalizeFlow(){
  if(Object.keys(cart).length === 0){ addMsgBot("Seu carrinho est√° vazio. Adicione itens antes de finalizar."); return; }
  if(!prontoParaFinalizar){
    // come√ßar fluxo autom√°tico
    addMsgBot("Antes de finalizar preciso do endere√ßo e contato. Vou te perguntar agora.");
    perguntarLocal();
    return;
  }

  const texto = encodeURIComponent(montarTextoWhatsApp());
  const url = `https://wa.me/${WA_NUMBER}?text=${texto}`;
  addMsgBot("Abrindo WhatsApp com seu pedido‚Ä¶");
  window.open(url, '_blank');
}

/* ================= COMANDOS E ENVIO DE MENSAGEM ================= */
function findProductByText(text){
  const t = text.trim().toLowerCase();
  if(!t) return null;
  for(const cat of Object.keys(PRODUCTS)){
    for(const [name,price] of Object.entries(PRODUCTS[cat])){
      if(name.toLowerCase().includes(t)) return { name, price };
    }
  }
  return null;
}

function enviarMsg(){
  const raw = msgBox.value.trim();
  if(!raw) return;
  addMsgUser(raw);
  msgBox.value = '';
  playClick();

  // se estamos no fluxo de coleta de dados
  if(processarRespostaFluxo(raw)) return;

  const lower = raw.toLowerCase();

  // palavras finaliza√ß√£o
  const palavrasFinalizar = ["finalizar","pronto","fechar","acabei","fechar pedido","finalizar pedido"];
  if(palavrasFinalizar.some(p => lower.includes(p))){
    if(prontoParaFinalizar){
      finalizarBtn.style.display = 'block';
      addMsgBot("Tudo certo! Clique em Finalizar Pedido para enviar via WhatsApp.", 300);
    } else {
      addMsgBot("Beleza ‚Äî antes de finalizar, vou pegar o endere√ßo e contato com voc√™.", 300);
      perguntarLocal();
    }
    return;
  }

  // comandos
  if(lower === 'menu' || lower === 'cardapio' || lower === 'card√°pio'){
    showMenu(); return;
  }
  if(lower === 'carrinho' || lower === 'mostrar carrinho'){
    renderCart(); addMsgBot("Aqui est√° seu carrinho."); return;
  }
  if(lower.startsWith('remover ')){
    const what = raw.substring(8).trim();
    if(cart[what]){ removeItem(what); addMsgBot(`Removido ${what}`); } else addMsgBot(`N√£o encontrei ${what} no carrinho.`);
    return;
  }

  // tentar encontrar produto pelo texto
  const found = findProductByText(raw);
  if(found){
    addToCart(found.name, found.price);
    return;
  }

  // fallback
  addMsgBot("N√£o entendi. Escreva o nome do produto (ex: 'contra fil√©'), ou 'finalizar' para encerrar o pedido.");
}

/* ================= PREVIEW / IMPRIMIR / COPIAR ================= */
function showPreview(){
  let html = `<div><strong>Churrasco do Chefe ‚Äî Pedido</strong><div class="meta">Bairro: ${escapeHtml((bairroSelect.value||'').split('|')[0]||'')}</div><hr></div>`;
  let subtotal = 0;
  Object.values(cart).forEach(it=>{
    html += `<div style="display:flex;justify-content:space-between;margin-bottom:6px"><div>${escapeHtml(it.name)} x ${it.qty}</div><div>${formatBR(it.price*it.qty)}</div></div>`;
    subtotal += it.price*it.qty;
  });
  const selected = (bairroSelect.value || '').split('|');
  const frete = parseFloat(selected[1]||0) || 0;
  html += `<hr><div style="display:flex;justify-content:space-between"><div>Subtotal</div><div>${formatBR(subtotal)}</div></div>`;
  html += `<div style="display:flex;justify-content:space-between"><div>Entrega</div><div>${formatBR(frete)}</div></div>`;
  html += `<div style="display:flex;justify-content:space-between;font-weight:800;margin-top:8px"><div>Total</div><div>${formatBR(subtotal+frete)}</div></div>`;
  if(enderecoLocal) html += `<hr><div><strong>Endere√ßo:</strong><div>${escapeHtml(enderecoLocal)} ‚Äî ${escapeHtml(enderecoNumero||'')}</div></div>`;
  if(clienteNome) html += `<div><strong>Nome:</strong> ${escapeHtml(clienteNome)}</div>`;
  if(clienteTelefone) html += `<div><strong>Telefone:</strong> ${escapeHtml(clienteTelefone)}</div>`;
  if(obsInput.value.trim()) html += `<hr><div><strong>Observa√ß√µes:</strong><div>${escapeHtml(obsInput.value)}</div></div>`;
  previewContent.innerHTML = html;
  previewModal.style.display = 'flex';
}
function closePreview(){ previewModal.style.display = 'none'; }
function printOrder(){
  const selected = (bairroSelect.value || '').split('|');
  const bairro = selected[0] || '';
  const frete = parseFloat(selected[1]||0) || 0;
  let subtotal = 0;
  let html = `<html><head><title>Pedido</title><style>body{font-family:Arial;padding:20px}</style></head><body>`;
  html += `<h2>Churrasco do Chefe ‚Äî Pedido</h2>`;
  html += `<div>Bairro: ${escapeHtml(bairro)}</div><hr>`;
  Object.values(cart).forEach(it=>{
    html += `<div style="display:flex;justify-content:space-between;margin-bottom:6px"><div>${escapeHtml(it.name)} x ${it.qty}</div><div>${formatBR(it.price*it.qty)}</div></div>`;
    subtotal += it.price*it.qty;
  });
  html += `<hr><div style="display:flex;justify-content:space-between"><div>Subtotal</div><div>${formatBR(subtotal)}</div></div>`;
  html += `<div style="display:flex;justify-content:space-between"><div>Entrega</div><div>${formatBR(frete)}</div></div>`;
  html += `<div style="display:flex;justify-content:space-between;font-weight:800;margin-top:8px"><div>Total</div><div>${formatBR(subtotal+frete)}</div></div>`;
  if(obsInput.value) html += `<hr><div><strong>Observa√ß√µes:</strong><div>${escapeHtml(obsInput.value)}</div></div>`;
  html += `</body></html>`;
  const w = window.open('','_blank');
  w.document.write(html); w.document.close(); w.print();
}
function copyOrder(){
  const selected = (bairroSelect.value || '').split('|');
  const bairro = selected[0] || '';
  const frete = parseFloat(selected[1]||0) || 0;
  let lines = [];
  lines.push("Novo Pedido - Churrasco do Chefe");
  let subtotal = 0;
  Object.values(cart).forEach(it=>{
    lines.push(`${it.name} x ${it.qty} ‚Äî ${formatBR(it.price*it.qty)}`);
    subtotal += it.price*it.qty;
  });
  lines.push(`Subtotal: ${formatBR(subtotal)}`);
  lines.push(`Entrega (${bairro}): ${formatBR(frete)}`);
  lines.push(`Total: ${formatBR(subtotal+frete)}`);
  if(obsInput.value) lines.push(`Observa√ß√µes: ${obsInput.value}`);
  navigator.clipboard.writeText(lines.join('\n')).then(()=> alert('Pedido copiado para √°rea de transfer√™ncia')).catch(()=> alert('N√£o foi poss√≠vel copiar automaticamente.'));
}

/* ================= TECLA ENTER e INICIALIZA√á√ÉO ================= */
document.getElementById('sendBtn').addEventListener('click', enviarMsg);
msgBox.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); enviarMsg(); } });

/* theme toggle */
const themeToggle = document.getElementById('themeToggle');
themeToggle.onclick = ()=> {
  const cur = document.documentElement.getAttribute('data-theme');
  if(cur === 'light'){ document.documentElement.removeAttribute('data-theme'); localStorage.setItem('theme','dark'); themeToggle.innerText = 'üåó'; }
  else { document.documentElement.setAttribute('data-theme','light'); localStorage.setItem('theme','light'); themeToggle.innerText = 'üåû'; }
};
if(localStorage.getItem('theme') === 'light'){ document.documentElement.setAttribute('data-theme','light'); themeToggle.innerText = 'üåû'; }

/* upload logo */
document.getElementById('logoInput').addEventListener('change', function(e){
  const file = this.files[0]; if(!file) return;
  const url = URL.createObjectURL(file); document.getElementById('logoImg').src = url;
});

/* iniciar */
(function init(){
  renderCategories();
  loadCart();
  renderCart();
  addMsgBot("üî• Ol√°! Eu sou o assistente do Churrasco do Chefe. Escreva o nome do produto para adicionar ou 'menu' para ver o card√°pio.", 400);
  finalizarBtn.style.display = 'none';
})();

/* ================= MANIFEST E SERVICE WORKER (SUGEST√ïES) ================= */
/*
manifest.json (salvar ao lado do index.html)
{
  "short_name":"Churrasco",
  "name":"Churrasco do Chefe - Atendimento",
  "icons":[{"src":"logo.png","sizes":"192x192","type":"image/png"}],
  "start_url":".",
  "display":"standalone",
  "theme_color":"#ff6a00",
  "background_color":"#111111"
}

sw.js (salvar ao lado)
self.addEventListener('install', e => { self.skipWaiting(); });
self.addEventListener('fetch', ()=>{});
*/

</script>
</body>
</html>